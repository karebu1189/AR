<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Hand Beam AR Game</title>
<style>
html, body {
  margin:0; padding:0; overflow:hidden; width:100%; height:100%;
  touch-action:none; /* スマホでスクロール無効 */
  background:black;
}
video, canvas {
  position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover;
}
</style>
</head>
<body>

<video id="camera" autoplay playsinline muted></video>
<canvas id="game"></canvas>

<script type="module">
import {Hands} from 'https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js';
import {Camera} from 'https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js';

const video = document.getElementById('camera');
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// 敵情報
let enemies = [];
for(let i=0;i<5;i++){
  enemies.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height/2+50, radius:30});
}

// ビーム情報
let beams = [];
let explosions = [];

// MediaPipe Hands 設定
const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
hands.setOptions({maxNumHands:1, minDetectionConfidence:0.7, minTrackingConfidence:0.7});

// 手の検出結果
hands.onResults(results=>{
  if(results.multiHandLandmarks && results.multiHandLandmarks.length>0){
    const lm = results.multiHandLandmarks[0];
    const x = lm[8].x * canvas.width;
    const y = lm[8].y * canvas.height;

    // 指を曲げたらビーム発射（人差し指先と第2関節の差）
    const curl = lm[8].y - lm[6].y;
    if(curl < -0.02){
      beams.push({x,y,vx:0,vy:-15});
    }
  }
});

// カメラ起動
const cam = new Camera(video, {onFrame: async()=>{await hands.send({image:video})}, width:640, height:480});
cam.start();

// 描画ループ
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // 敵描画
  ctx.fillStyle='red';
  enemies.forEach(e=>{
    ctx.beginPath();
    ctx.arc(e.x,e.y,e.radius,0,Math.PI*2);
    ctx.fill();
  });

  // ビーム描画
  ctx.fillStyle='cyan';
  beams.forEach((b,i)=>{
    b.y += b.vy;
    ctx.beginPath();
    ctx.arc(b.x,b.y,10,0,Math.PI*2);
    ctx.fill();

    // 衝突判定
    enemies.forEach((e,j)=>{
      const dx = b.x - e.x;
      const dy = b.y - e.y;
      const dist = Math.sqrt(dx*dx+dy*dy);
      if(dist < e.radius+10){
        explosions.push({x:e.x,y:e.y,t:20});
        enemies.splice(j,1);
        beams.splice(i,1);
      }
    });
  });

  // 爆発描画
  explosions.forEach((ex,i)=>{
    ctx.fillStyle=`rgba(255,255,0,${ex.t/20})`;
    ctx.beginPath();
    ctx.arc(ex.x,ex.y,40*(1-ex.t/20),0,Math.PI*2);
    ctx.fill();
    ex.t--;
    if(ex.t<=0) explosions.splice(i,1);
  });

  requestAnimationFrame(draw);
}

draw();
</script>
</body>
</html>
