<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Hand Beam AR Game</title>
<style>
  body { margin:0; overflow:hidden; background:black; }
  canvas { position:absolute; top:0; left:0; }
  video { display:none; }
</style>
</head>
<body>
<video id="camera" autoplay playsinline></video>
<canvas id="game"></canvas>

<script type="module">
import {Hands} from 'https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js';
import {Camera} from 'https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js';

const video = document.getElementById('camera');
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// 敵オブジェクト
let enemies = [];
for(let i=0;i<5;i++){
  enemies.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height/2 + 50, radius:30});
}

// ビーム配列
let beams = [];

// 爆発配列
let explosions = [];

// MediaPipe Hands
const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
hands.setOptions({maxNumHands:1, minDetectionConfidence:0.7, minTrackingConfidence:0.7});

hands.onResults(results => {
  if(results.multiHandLandmarks && results.multiHandLandmarks.length>0){
    const lm = results.multiHandLandmarks[0];
    const x = lm[8].x * canvas.width; // 人差し指先
    const y = lm[8].y * canvas.height;
    
    // 左クリックみたいに指を曲げたらビーム発射
    const curl = lm[8].y - lm[6].y; // 指先と指の付け根の差
    if(curl < -0.02){
      beams.push({x,y, vx:0, vy:-10});
    }
  }
});

// カメラ起動
const cam = new Camera(video, {onFrame: async()=>{ await hands.send({image:video}) }, width:640, height:480});
cam.start();

// 描画ループ
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // 敵描画
  ctx.fillStyle = 'red';
  enemies.forEach(e => {
    ctx.beginPath();
    ctx.arc(e.x, e.y, e.radius, 0, Math.PI*2);
    ctx.fill();
  });

  // ビーム描画
  ctx.fillStyle='cyan';
  beams.forEach((b, i)=>{
    b.y += b.vy;
    ctx.beginPath();
    ctx.arc(b.x, b.y, 8, 0, Math.PI*2);
    ctx.fill();

    // 当たり判定
    enemies.forEach((e,j)=>{
      const dx = b.x - e.x;
      const dy = b.y - e.y;
      const dist = Math.sqrt(dx*dx+dy*dy);
      if(dist < e.radius+8){
        explosions.push({x:e.x, y:e.y, t:20});
        enemies.splice(j,1);
        beams.splice(i,1);
      }
    });
  });

  // 爆発描画
  explosions.forEach((ex,i)=>{
    ctx.fillStyle = `rgba(255,255,0,${ex.t/20})`;
    ctx.beginPath();
    ctx.arc(ex.x, ex.y, 40*(1-ex.t/20),0,Math.PI*2);
    ctx.fill();
    ex.t--;
    if(ex.t<=0) explosions.splice(i,1);
  });

  requestAnimationFrame(draw);
}

draw();
</script>
</body>
</html>
